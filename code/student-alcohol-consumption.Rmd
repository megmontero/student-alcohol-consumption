---
title: "Código Práctica 2: Limpieza dataset 'Student Alcohol Consumption '"
author: "Gregorio Andrés García Menéndez (gagarcia) & Manuel Gómez Montero (megmontero)"
date: "Junio, 2019"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
lang: es
---



```{r setup, include=FALSE}
# Change depending on your working directory
working_directory <- "F:/Drive/M?ster Data Science/Tipología y ciclo de la vida de los datos/PRAC2/student-alcohol-consumption"
working_directory <- "./"
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '', root.dir = working_directory)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(statnet.common)
```

**Introducción**

[A COMPLETAR]


# Limpieza de datos


## Lectura de datos 

Leemos ambos ficheros mostramos resumen para matemáticas:

```{r}
students.mat=read.table("../data/student-mat.csv",sep=",",header=TRUE)
students.por=read.table("../data/student-por.csv",sep=",",header=TRUE)
summary(students.mat)


```


Y para portugués: 

```{r}
summary(students.por)
```

## Union de fuentes

<<<<<<< HEAD
En el código de ejemplo los unía a ver que ver si tiene sentido, ya que no son los mismos alumnos.
=======
En el código de ejemplo los unía a ver que ver si tiene sentido. ya que no son los mismos alumnos.
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3

```{r}
students=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))
summary(students)
```


```{r}
students.both=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health"))

summary(students.both)
```

<<<<<<< HEAD
Vemos cuáles realmente serían del mismo conjunto
=======
Vemos cuales realmente serían del mismo conjunto
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3
```{r}
print(nrow(students.both[students$guardian.y!=students$guardian.x,c("guardian.x", "guardian.y")]))
print(nrow(students.both[students$guardian.y!=students$guardian.x,c("famsup.x", "famsup.y")]))
print(nrow(students.both[students$studytime.y!=students$studytime.x,c("studytime.x", "studytime.y")]))
print(nrow(students.both[students$paid.y!=students$paid.x,c("paid.x", "paid.y")]))
print(nrow(students.both[students$absences.y!=students$absences.x,c("absences.x", "absences.y")]))

```

Por lo que creamos el dataset final
```{r}
students.merge=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime"), all = TRUE,suffixes = c(".mat",".por"))
summary(students.merge)

# Save the dataset temporaly 
write.table(students, "../data/students.csv", sep=",", col.names=TRUE, row.names=TRUE, quote=TRUE, na="NA")
```



## Eliminamos NAs


Primeros creamos un nuevo dataset y unificamos la variable paid. 
```{r}
students.nonas <- students.merge[, c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime")]
students.nonas$paid <- "no"
students.nonas$paid[NVL(students.merge$paid.mat == 'yes' | students.merge$paid.por == 'yes', FALSE)] <- "yes"
students.nonas$paid <- as.factor(students.nonas$paid)

summary(students.nonas)

```


Aplicamos un proceso similar para las calificaciones, utilizando la media en el caso que existan ambas:

```{r}
students.nonas$G1 <- rowMeans(students.merge[c('G1.mat', 'G1.por')], na.rm=TRUE)
students.nonas$G2 <- rowMeans(students.merge[c('G2.mat', 'G2.por')], na.rm=TRUE)
students.nonas$G3 <- rowMeans(students.merge[c('G3.mat', 'G3.por')], na.rm=TRUE)
summary(students.nonas)

```
Por último lo aplicamos a las ausencias, antes de aplicar la media normalizamos los valores

```{r}
normalized<-function(y) {
  x<-y[!is.na(y)]
  x<-(x - min(x)) / (max(x) - min(x))
  y[!is.na(y)]<-x
  return(y)
}


students.nonas$absences <- rowMeans(sapply(students.merge[c('absences.mat', 'absences.por')], normalized), na.rm=TRUE)

summary(students.nonas)  

```




## Reducción dimensionalidad


Como no vamos a centrar los estudios comparando estudiantes de distintos colegios, eliminamos la variable School, y calculamos la evaluacion como la media:
```{r}
students.red <- students.nonas[,c("sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime", "absences", "paid")]
students.red$G <-  rowMeans(students.nonas[c('G1', 'G2', 'G3')])

summary(students.red)

```

## Tipo de variables

```{r}
sapply( students.red, class)

```

En los tipos mostrados hay algunos que no es correcto el tipo. En la educación tanto de la madre como del padre consideramos que aunque se use un número para la representación debería ser un factor. Lo mismo ocurre para el tiempo de viaje o el tiempo de estudio. 

```{r}
students.red$Medu <-as.factor(students.red$Medu) 
students.red$Fedu <-as.factor(students.red$Fedu) 
students.red$traveltime <-as.factor(students.red$traveltime) 
students.red$studytime <-as.factor(students.red$studytime) 

```

La explicación de considerar el tiempo de estudio y el tiempo de viaje es que, aunque pueden parecer numéricas, en realizar son factores. En la descripción del dataset aparece explicado:

studytime: Weekly study time: (numeric: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours)
traveltime: Home to school travel time (numeric: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour)

<<<<<<< HEAD
Por lo tanto, al ser categorías, las tratamos como factores y no como numéricas.



=======
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3
# Análisis Estadístico

## Análisis gráfico inicial

```{r}
vars = c("sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "health", "guardian", "famsup", "studytime", "absences", "paid", "G")
objs = c("Dalc", "Wcalc")



library(ggplot2)

for(i in vars) {
  if(is.factor(students.red[,i])){
    f1 = students.red[,i]
    plot <- ggplot(data = students.red, aes(x = f1, y = students.red[,"Walc"])) + 
            geom_boxplot(aes(fill = f1), width = 0.8) + theme_bw()  +
            xlab(i) + ylab("Weekend Consumption")
    print(plot)
    plot <- ggplot(data = students.red, aes(x = f1, y = students.red[,"Dalc"])) + 
            geom_boxplot(aes(fill = f1), width = 0.8) + theme_bw()  +
            xlab(i) + ylab("Weekday Consumption")
    print(plot)
  }
}

```


<<<<<<< HEAD

=======
 
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3
Viendo las gráficas vemos que hay variables que parece que sí tienen influencia a simple vista en el consumo de alcohol tanto a diario como los fines de semana como pueden ser el sexo o el estado de los padres. Sin embargo vemos otros que, a priori, no parece que tengan influencia, así que en un primer momento vamos a dejar fuera del análisis si el alumno tiene internet, si tiene una relación, el tutor, la dirección, si realiza actividades extraescolares, si recibe clases de pago, si ha ido a la guardería, o si  recibe el apoyo de su familia en el estudio. 

El dataset resultante y con el que continuaremos trabajando es el siguiente: 

```{r}
students <- students.red[,c("sex","age","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason", "traveltime", "failures", "schoolsup", "higher",  "famrel", "freetime", "goout", "Dalc", "Walc", "health", "studytime", "absences", "G")]
summary(students)
```

## Análisis de Outliers

Para las variables numéricas realizamos un estudio de outliers. En nuestro caso, las variables a estudiar son "age" y "G". El resto de variables numéricas en realidad no lo son, puesto que son categóricas. Por ejemplo: "studytime" va de 1 a 4, y no hace referencia a las horas que el alumno pasa estudiando, sino que son categorías equivalentes a por ejemplo: Nada, Poco, Normal, Mucho. Podría haber valores erróneos debido a la transcripción de los datos o similar, pero dichos errores ya los hubiéramos detectado en la creación del data set, ya que gracias a la función "summary" vemos los valores mínimos y máximos y para estas variables categóricas numéricas no hay valores erróneos (mínimo y máximo corresponden a las categorías mínimas y máximas).

Procedemos al estudio de "age" y "G":

```{r}
plot(students$age)

plot(students$age, students$Walc, xlab="age", ylab="Walc", pch="*", col="red")
abline(lm(students$Walc ~ students$age), col="blue", lwd=3, lty=2)

age_no_outliers <- students$age[students$age <= 21]
walc_no_outliers <- students$Walc[students$age <= 21]
plot(age_no_outliers, walc_no_outliers, xlab="age", ylab="Walc", pch="*", col="red")
abline(lm(walc_no_outliers ~ age_no_outliers), col="blue", lwd=3, lty=2)
```
Como podemos ver, para el campo edad los alumnos van de los 15 a los 22, siendo las franjas más pobladas los 15, 16 y 17 años. Al haber valores intermedios que en número van disminuyendo gradualmente desde los 18 hasta los 22, no consideramos ningún valor extremo (como el único estudiantes de 22 años) como valor erróneo. Además, al ser tan pocos estudiantes, no los descartamos en nuestros estudios ya que pueden aportar información valiosa, y como podemos ver en la comparativa del conjunto con outliers y sin outliers, no cambia de forma crítica.


```{r}
plot(students$G)

plot(students$G, students$Walc, xlab="G", ylab="Walc", pch="*", col="red")
abline(lm(students$Walc ~ students$G), col="blue", lwd=3, lty=2)
```
En el caso de la media de la nota "G" es más claro todavía. Los datos no demuestran valores extremos que se puedan deber a errores, y aquellos más alejados de la mayor concentración de estudiantes son valores que aportan información para los estudios que vamos a realizar en cuanto al consumo de alcohol y de desempeño estudiantil.


## Estadistica Inferencial 

En este apartado vamos a ver si hay diferencia significativas en el consumo de alcohol a diario o fines de semana entre:
  - Estudiantes de distinto sexo
  - Estudiantes con diferente situación de convivencia de los padres.
  - Estudiantes que aprueban (G >= 10) y estudiantes que suspenden (G < 10)  
  
Se trata de un problema de diferencia de medias entre dos muestras.


Para cada caso la hipótesis sería: 


$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_{g1}-\mu_{g2}=0\\
H_{1}: & \mu_{g1}-\mu_{g2}\ne0
\end{array}
\right.
$$

Se trata de un problema de diferencia de medias en el que no conocemos la varianza poblacional. Tampoco sabemos a priori si los datos siguen una distribución normal, pero el tamaño de las muestras es lo suficientemente grande para tener en cuenta el teorema del límite central.


Para el alcohol en fines de semana por sexo: 

```{r}
data_weekend_sex_m <- students$Walc[students$sex == 'M'] 
data_weekend_sex_f <- students$Walc[students$sex == 'F'] 

t.test(data_weekend_sex_m, data_weekend_sex_f, var.equal = TRUE, conf.level = 0.95)
```
Por el p-value vemos que no podemos aceptar la hipótesis nula, y concluimos que al 95% de nivel de confianza los estudiantes masculinos y femeninos no tienen el mismo consumo de alcohol los fines de semana.  



Por sexo entre semana: 

```{r}
data_weekday_sex_m <- students$Dalc[students$sex == 'M'] 
data_weekday_sex_f <- students$Dalc[students$sex == 'F'] 

t.test(data_weekday_sex_m, data_weekday_sex_f, var.equal = TRUE, conf.level = 0.95)
```
<<<<<<< HEAD
Por el p-value vemos que ocurre lo mismo que en los fines de semana. No podemos acepta la hipótesis nula y al 95% afirmamos que hay diferencia en el consumo de alcohol entre estudiantes masculinos y femeninos para los d?as entre semana.


Ahora realizamos el estudio para el consumo de alcohol según la situaci?n de los padres de cada alumno:
=======
Por el p-value vemos que ocurre lo mismo que en los fines de semana. No podemos acepta la hipotésis nula y al 95% afirmamos que hay diferencia en el consumo de alcohol entre estudiantes masculinos y femeninos para los días entre semana.


Ahora realizamos el estudio para el consumo de alcohol según la situación de los padres de cada alumno:
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3
```{r}
data_weekday_pstatus_t <- students$Dalc[students$Pstatus == 'T'] 
data_weekday_pstatus_a <- students$Dalc[students$Pstatus == 'A'] 

t.test(data_weekday_pstatus_t, data_weekday_pstatus_a, var.equal = TRUE, conf.level = 0.95)
```
<<<<<<< HEAD
Con un p-value tan alto aceptamos la hipótesis nula, concluyendo que el consumo de alcohol entre semana es el mismo para estudiantes cuyos padres viven juntos y para estudiantes cuyos padres viven separados
=======
Con un p-value tan alto aceptamos la hipótesis nula, concluyendo que el consumo de alcohol entre semana es el mismo para estudiantes cuyos padres viven juntos y para estudiatnes cuyos padres viven separados
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3



```{r}
data_weekend_pstatus_t <- students$Walc[students$Pstatus == 'T'] 
data_weekend_pstatus_a <- students$Walc[students$Pstatus == 'A'] 

t.test(data_weekend_pstatus_t, data_weekend_pstatus_a, var.equal = TRUE, conf.level = 0.95)
```
En el caso del consumo en los fines de semana, ocurre lo mismo: no hay diferencias significativas en función del estado de convivencia de los padres



Por último, realizamos el estudio para el consumo de alcohol según las calificaciones que obtiene el alumno (si aprueba o suspende):
```{r}
data_weekday_aprobados <- students$Dalc[students$G >= 10] 
data_weekday_suspensos <- students$Dalc[students$G < 10] 

t.test(data_weekday_aprobados, data_weekday_suspensos, var.equal = TRUE, conf.level = 0.95)
```
Viendo el p-value, podemos decir al 95% que sí hay diferencias entre alumnos que aprueban y alumnos que suspenden en cuanto al consumo de alcohol entre semana.


En el caso del consumo los fines de semana:
```{r}
data_weekend_aprobados <- students$Walc[students$G >= 10] 
data_weekend_suspensos <- students$Walc[students$G < 10] 

t.test(data_weekend_aprobados, data_weekend_suspensos, var.equal = TRUE, conf.level = 0.95)
```
Con un p-value menor que 0.05, al 95% de confianza afirmamos que también hay diferencia en el consumo de alcohol los fines de semana en función de si el alumno aprueba o no.



## Regresión 

En este apartado aplicaremos un modelo de regresión lineal múltiple que use como variables explicativas el sexo,
la frecuencia con la que el estudiante sale con amigos, la edad y como variable dependiente el consumo de alcohol los fines de semana. 

Al usar regresores cualitativos, es importante definir una categoría de referencia, para lo que usaremos la función de R *relevel* estableciendo la categoría "F" como referente para el sexo. El resultado lo almacenamos en una nueva variable.


```{r}
students$sexR <- relevel(students$sex, "F")
modelo <- lm(Walc ~  goout + sexR + age, data = students )
summary(modelo)
```

Los coeficientes obtenidos para cada variable son: 


Observando el coeficiente de determinación $R^{2}$ vemos que la proporción de variabilidad explicada por el modelo con respecto a la variabilidad total  es unicamente del 25%



Otro modelo lineal que podemos estudiar es el consumo de alcohol los fines de semana en función de cuánto sale el estudiante con amigos, cuánto bebe entre semana, su sexo y su edad
```{r}
students$sexR <- relevel(students$sex, "F")
modelo <- lm(Walc ~ goout + sexR + Dalc + age + studytime, data = students )
summary(modelo)
```
Como podemos ver, aspectos que influyen mucho en el modelo son:
  - Que el alumno salga con amigos
  - Que el alumno sea de sexo masculino
  - Si el alumno bebe entre semana tenderá a beber más los fines de semana
  - Cuanto más tiempo de estudio dedica el alumno, menos bebe

La edad no influye de forma significativa para el consumo de alcohol según el modelo.

En este caso, el modelo explica un 48% de la variabilidad en los datos.



# Correlación

Estudiamos el de nivel de significancia de la relación entre la calificación que obtienen los alumnos y otro tipo de factores:
  - Sexo
  - Edad
  - Consumo de alcohol los fines de semana
  - Consumo de alcohol entre semana
<<<<<<< HEAD
  - Situaci?n de los padres (cohabitando o no)
  
Al estudiar el nivel de relación entre una variable continua (la nota) y variables categóricas (el resto), usamos el test ANOVA para obtener este nivel de significancia:
=======
  - Situación de los padres (cohabitando o no)
  
Al estudiar el nivel de relación entre una variable contínua (la nota) y variables categóricas (el resto), usamos el test ANOVA para obtener este nivel de significancia:
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3
```{r}
# Sexo
aov1 = aov(students$G ~ students$sex)
summary(aov1)
# Edad
aov1 = aov(students$G ~ students$age)
summary(aov1)
# Consumo de alcohol fines de semana
aov1 = aov(students$G ~ students$Walc)
summary(aov1)
# Consumo de alcohol entre semana
aov1 = aov(students$G ~ students$Dalc)
summary(aov1)
<<<<<<< HEAD
# Situaci?n de los padres
aov1 = aov(students$G ~ students$Pstatus)
=======
# Situación de los padres
aov1 = aov(students.red$G ~ students.red$Pstatus)
>>>>>>> 7ef5138ef769d8f38bb238bb81e80dedb3276ca3
summary(aov1)


```
Como podemos observar, no hay correlación entre la calificación del estudiante y el sexo o el estado de convivencia de los padres. Sin embargo, en el desempeño escolar de los estudiantes sí que influyen significativamente la edad y el consumo de alcohol tanto en fines de semana como entre semana.



