---
title: "C√≥digo Pr√°ctica 2: Limpieza dataset 'Student Alcohol Consumption '"
author: "Gregorio Andr√©s Garc√≠a Men√©ndez (gagarcia) & Manuel Gomez Montero (megmontero)"
date: "Junio, 2019"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
lang: es
---



```{r setup, include=FALSE}
# Change depending on your working directory
working_directory <- "F:/Drive/M?ster Data Science/Tipolog?a y ciclo de la vida de los datos/PRAC2/student-alcohol-consumption"

knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '', root.dir = working_directory)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(statnet.common)
```

**IntroducciÛn**

[A COMPLETAR]


# Limpieza de datos


## Lectura de datos 

Leemos ambos ficheros mostramos resumen para matem·ticas:

```{r}
students.mat=read.table("../data/student-mat.csv",sep=",",header=TRUE)
students.por=read.table("../data/student-por.csv",sep=",",header=TRUE)
summary(students.mat)


```


Y para portuguÈs: 

```{r}
summary(students.por)
```

## Union de fuentes

En el cÛdigo de ejemplo los unÌa a ver que ver si tiene sentido. ya que no son los mismos alumnos.

```{r}
students=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))
summary(students)
```


```{r}
students.both=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health"))

summary(students.both)
```

Vemos cuales realmente serÌan del mismo conjunto
```{r}
print(nrow(students.both[students$guardian.y!=students$guardian.x,c("guardian.x", "guardian.y")]))
print(nrow(students.both[students$guardian.y!=students$guardian.x,c("famsup.x", "famsup.y")]))
print(nrow(students.both[students$studytime.y!=students$studytime.x,c("studytime.x", "studytime.y")]))
print(nrow(students.both[students$paid.y!=students$paid.x,c("paid.x", "paid.y")]))
print(nrow(students.both[students$absences.y!=students$absences.x,c("absences.x", "absences.y")]))

```

Por lo que creamos el dataset final
```{r}
students.merge=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime"), all = TRUE,suffixes = c(".mat",".por"))
summary(students.merge)

# Save the dataset temporaly 
write.table(students, "../data/students.csv", sep=",", col.names=TRUE, row.names=TRUE, quote=TRUE, na="NA")
```



## Eliminamos NAs


Primeros creamos un nuevo dataset y unificamos la variable paid. 
```{r}
students.nonas <- students.merge[, c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime")]
students.nonas$paid <- "no"
students.nonas$paid[NVL(students.merge$paid.mat == 'yes' | students.merge$paid.por == 'yes', FALSE)] <- "yes"
students.nonas$paid <- as.factor(students.nonas$paid)

summary(students.nonas)

```


Aplicamos un proceso similar para las calificaciones, utilizando la media en el caso que existan ambas:

```{r}
students.nonas$G1 <- rowMeans(students.merge[c('G1.mat', 'G1.por')], na.rm=TRUE)
students.nonas$G2 <- rowMeans(students.merge[c('G2.mat', 'G2.por')], na.rm=TRUE)
students.nonas$G3 <- rowMeans(students.merge[c('G3.mat', 'G3.por')], na.rm=TRUE)
summary(students.nonas)

```
Por ˙ltimo lo aplicamos a las ausencias, antes de aplicar la media normalizamos los valores

```{r}
normalized<-function(y) {
  x<-y[!is.na(y)]
  x<-(x - min(x)) / (max(x) - min(x))
  y[!is.na(y)]<-x
  return(y)
}


students.nonas$absences <- rowMeans(sapply(students.merge[c('absences.mat', 'absences.por')], normalized), na.rm=TRUE)

summary(students.nonas)  

```




## ReducciÛn dimensionalidad


Como no vamos a centrar los estudios comparando estudiantes de distintos colegios, eliminamos la variable School, y calculamos la evaluacion como la media:
```{r}
students.red <- students.nonas[,c("sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime", "absences", "paid")]
students.red$G <-  rowMeans(students.nonas[c('G1', 'G2', 'G3')])

summary(students.red)

```

## Tipo de variables

```{r}
sapply( students.red, class)

```

En los tipos mostrados hay algunos que no es correcto el tipo. En la educaciÛn tanto de la madre como del padre consideramos que aunque se use un n˙mero para la representaciÛn deberÌa ser un factor. Lo mismo ocurre para el tiempo de viaje o el tiempo de estudio. 

```{r}
students.red$Medu <-as.factor(students.red$Medu) 
students.red$Fedu <-as.factor(students.red$Fedu) 
students.red$traveltime <-as.factor(students.red$traveltime) 
students.red$studytime <-as.factor(students.red$studytime) 

```



# An√°lisis EstadÌstico

## An√°lisis gr√°fico inicial

```{r}
vars = c("sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "health", "guardian", "famsup", "studytime", "absences", "paid", "G")
objs = c("Dalc", "Wcalc")



library(ggplot2)

for(i in vars) {
  if(is.factor(students.red[,i])){
    f1 = students.red[,i]
    plot <- ggplot(data = students.red, aes(x = f1, y = students.red[,"Walc"])) + 
            geom_boxplot(aes(fill = f1), width = 0.8) + theme_bw()  +
            xlab(i) + ylab("Weekend Consumption")
    print(plot)
    plot <- ggplot(data = students.red, aes(x = f1, y = students.red[,"Dalc"])) + 
            geom_boxplot(aes(fill = f1), width = 0.8) + theme_bw()  +
            xlab(i) + ylab("Weekday Consumption")
    print(plot)
  }
}

```



Viendo las gr·ficas vemos que hay variables que parece que sÌ tienen influencia a simple vista en el consumo de alcohol tanto a diario como los fines de semana como pueden ser el sexo o el estado de los padres. Sin embargo vemos otros que, a priori, no parece que tengan influencia, asÌ que en un primer momento vamos a dejar fuera del an·lisis si el alumno tiene internet, si tiene una relaciÛn, el tutor, la direcciÛn, si realiza actividades extraescolares, si recibe clases de pago, si ha ido a la guarderÌa, o si  recibe el apoyo de su familia en el estudio. 

El dataset resultante y con el que continuaremos trabajando es el siguiente: 

```{r}
students <- students.red[,c("sex","age","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason", "traveltime", "failures", "schoolsup", "higher",  "famrel", "freetime", "goout", "Dalc", "Walc", "health", "studytime", "absences", "G")]
summary(students)
```




## Estadistica Inferencial 

En este apartado vamos a ver si hay diferencia significativas en el consumo de alcohol a diario o fines de semana entre:
  - Estudiantes de distinto sexo
  - Estudiantes con diferente situaciÛn de convivencia de los padres.
  - Estudiantes que aprueban (G >= 10) y estudiantes que suspenden (G < 10)  
  
Se trata de un problema de diferencia de medias entre dos muestras.


Para cada caso la hipÛtesis serÌa: 


$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_{g1}-\mu_{g2}=0\\
H_{1}: & \mu_{g1}-\mu_{g2}\ne0
\end{array}
\right.
$$

Se trata de un problema de diferencia de medias en el que no conocemos la varianza poblacional. Tampoco sabemos a priori si los datos siguen una distribuciÛn normal, pero el tamaÒo de las muestras es lo suficientemente grande para tener en cuenta el teorema del lÌmite central.


Para el alcohol en fines de semana por sexo: 

```{r}
data_weekend_sex_m <- students$Walc[students$sex == 'M'] 
data_weekend_sex_f <- students$Walc[students$sex == 'F'] 

t.test(data_weekend_sex_m, data_weekend_sex_f, var.equal = TRUE, conf.level = 0.95)
```
Por el p-value vemos que no podemos aceptar la hipÛtesis nula, y concluimos que al 95% de nivel de confianza los estudiantes masculinos y femeninos no tienen el mismo consumo de alcohol los fines de semana.  



Por sexo entre semana: 

```{r}
data_weekday_sex_m <- students$Dalc[students$sex == 'M'] 
data_weekday_sex_f <- students$Dalc[students$sex == 'F'] 

t.test(data_weekday_sex_m, data_weekday_sex_f, var.equal = TRUE, conf.level = 0.95)
```
Por el p-value vemos que ocurre lo mismo que en los fines de semana. No podemos acepta la hipotÈsis nula y al 95% afirmamos que hay diferencia en el consumo de alcohol entre estudiantes masculinos y femeninos para los dÌas entre semana.


Ahora realizamos el estudio para el consumo de alcohol seg˙n la situaciÛn de los padres de cada alumno:
```{r}
data_weekday_pstatus_t <- students$Dalc[students$Pstatus == 'T'] 
data_weekday_pstatus_a <- students$Dalc[students$Pstatus == 'A'] 

t.test(data_weekday_pstatus_t, data_weekday_pstatus_a, var.equal = TRUE, conf.level = 0.95)
```
Con un p-value tan alto aceptamos la hipÛtesis nula, concluyendo que el consumo de alcohol entre semana es el mismo para estudiantes cuyos padres viven juntos y para estudiatnes cuyos padres viven separados



```{r}
data_weekend_pstatus_t <- students$Walc[students$Pstatus == 'T'] 
data_weekend_pstatus_a <- students$Walc[students$Pstatus == 'A'] 

t.test(data_weekend_pstatus_t, data_weekend_pstatus_a, var.equal = TRUE, conf.level = 0.95)
```
En el caso del consumo en los fines de semana, ocurre lo mismo: no hay diferencias significativas en funciÛn del estado de convivencia de los padres



Por ˙ltimo, realizamos el estudio para el consumo de alcohol seg˙n las calificaciones que obtiene el alumno (si aprueba o suspende):
```{r}
data_weekday_aprobados <- students$Dalc[students$G >= 10] 
data_weekday_suspensos <- students$Dalc[students$G < 10] 

t.test(data_weekday_aprobados, data_weekday_suspensos, var.equal = TRUE, conf.level = 0.95)
```
Viendo el p-value, podemos decir al 95% que sÌ hay diferencias entre alumnos que aprueban y alumnos que suspenden en cuanto al consumo de alcohol entre semana.


En el caso del consumo los fines de semana:
```{r}
data_weekend_aprobados <- students$Walc[students$G >= 10] 
data_weekend_suspensos <- students$Walc[students$G < 10] 

t.test(data_weekend_aprobados, data_weekend_suspensos, var.equal = TRUE, conf.level = 0.95)
```
Con un p-value menor que 0.05, al 95% de confianza afirmamos que tambiÈn hay diferencia en el consumo de alcohol los fines de semana en funciÛn de si el alumno aprueba o no.



## RegresiÛn 

En este apartado aplicaremos un modelo de regresiÛn lineal m˙ltiple que use como variables explicativas el sexo,
la frecuencia con la que el estudiante sale con amigos, la edad y como variable dependiente el consumo de alcohol los fines de semana. 

Al usar regresores cualitativos, es importante definir una categorÌa de referencia, para lo que usaremos la funciÛn de R *relevel* estableciendo la categorÌa "F" como referente para el sexo. El resultado lo almacenamos en una nueva variable.


```{r}
students$sexR <- relevel(students$sex, "F")
modelo <- lm(Walc ~  goout + sexR + age, data = students )
summary(modelo)
```

Los coeficientes obtenidos para cada variable son: 


Observando el coeficiente de determinacion $R^{2}$ vemos que la proporci√≥n de variabilidad explicada por el modelo con respecto a la variabilidad total  es unicamente del 25%



Otro modelo lineal que podemos estudiar es el consumo de alcohol los fines de semana en funciÛn de cu·nto sale el estudiante con amigos, cu·nto bebe entre semana, su sexo y su edad
```{r}
students$sexR <- relevel(students$sex, "F")
modelo <- lm(Walc ~ goout + sexR + Dalc + age + studytime, data = students )
summary(modelo)
```
Como podemos ver, aspectos que influyen mucho en el modelo son:
  - Que el alumno salga con amigos
  - Que el alumno sea de sexo masculino
  - Si el alumno bebe entre semana tender· a beber m·s los fines de semana
  - Cuanto m·s tiempo de estudio dedica el alumno, menos bebe

La edad no influye de forma significativa para el consumo de alcohol seg˙n el modelo.

En este caso, el modelo explica un 48% de la variabilidad en los datos.



# CorrelaciÛn

Estudiamos el de nivel de significancia de la relaciÛn entre la calificaciÛn que obtienen los alumnos y otro tipo de factores:
  - Sexo
  - Edad
  - Consumo de alcohol los fines de semana
  - Consumo de alcohol entre semana
  - SituaciÛn de los padres (cohabitando o no)
  
Al estudiar el nivel de relaciÛn entre una variable contÌnua (la nota) y variables categÛricas (el resto), usamos el test ANOVA para obtener este nivel de significancia:
```{r}
# Sexo
aov1 = aov(students.red$G ~ students.red$sex)
summary(aov1)
# Edad
aov1 = aov(students.red$G ~ students.red$age)
summary(aov1)
# Consumo de alcohol fines de semana
aov1 = aov(students.red$G ~ students.red$Walc)
summary(aov1)
# Consumo de alcohol entre semana
aov1 = aov(students.red$G ~ students.red$Dalc)
summary(aov1)
# SituaciÛn de los padres
aov1 = aov(students.red$G ~ students.red$Pstatus)
summary(aov1)


```
Como podemos observar, no hay correlaciÛn entre la calificaciÛn del estudiante y el sexo o el estado de convivencia de los padres. Sin embargo, en el desempeÒo escolar de los estudiantes sÌ que influyen significativamente la edad y el consumo de alcohol tanto en fines de semana como entre semana.



OLD
------------------------------------------




# An√°lisis gr√°fico inicial





Sexo
```{r}
par(mfrow=c(1,2))
boxplot(Walc~sex,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~sex,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Parece que los hombres beben m√°s.


Edad
```{r}
par(mfrow=c(1,2))
boxplot(Walc~age,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~age,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Parece que los mayores beben m√°s entre semana.



             Fedu             Mjob           Fjob            reason    nursery   internet    traveltime       failures      schoolsup activities higher 
 
 
```{r}
par(mfrow=c(1,2))
boxplot(Walc~Medu,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~Medu,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```
 
 
```{r}
par(mfrow=c(1,2))
boxplot(Walc~Fedu,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~Fedu,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```
 
 
 
 


famsize
```{r}
par(mfrow=c(1,2))
boxplot(Walc~famsize,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~famsize,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```





Alcohol fin de sema y entre semana en funci√≥n del estado de los padres 
```{r}
par(mfrow=c(1,2))

boxplot(Walc~Pstatus,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~Pstatus,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))

```


Si salen con amigos
```{r}
par(mfrow=c(1,2))
boxplot(Walc~goout,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~goout,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Parece que los que m√°s salen, beben m√°s los fines de semana. 



```{r}
par(mfrow=c(1,2))
boxplot(Walc~studytime,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~studytime,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Los que menos estudian, beben m√°s los fines de semana.



```{r}
par(mfrow=c(1,2))
boxplot(Walc~famrel,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~famrel,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Los que tienen buena relaci√≥n con la familia no beben a diario. 






#Backup Goyo

Despu?s de hacer varias pruebas quitando y poniendo variables, he llegado a la conclusi?n de asumir todas como comunes para estudiantes que se encuentran en las dos clases excepto las notas (G1, G2 y G3).
Es decir, asumimos que alumnos cuyo todo conjunto de variables menos las notas es igual en los dos ficheros, se trata del mismo alumno. Haci?ndolo de este modo quedan:
```{r}
# 100 alumnos que dan matem?ticas y portugu?s 
nrow(students[!is.na(students$G1.x) & !is.na(students$G1.y),])
# 295 alumnos que dan s?lo matem?ticas
nrow(students[!is.na(students$G1.x) & is.na(students$G1.y),])
# 549 alumnos que dan s?lo portugu?s
nrow(students[is.na(students$G1.x) & !is.na(students$G1.y),])
# 0 datos an?malos (que no est?n en ninguna de las dos clases)
nrow(students[is.na(students$G1.x) & is.na(students$G1.y),])
```
Tras tener este dataset, nuestros objetivos pueden ser ver c?mo influyen ciertos factores sociales (tiempo libre, familia, etc) en dos cosas:
- Consumo de alcohol del alumno
- Calificaciones del alumno
(y la una sobre la otra seg?n que caso)

Se me ocurre que de este dataset se puede tambi?n estudiar por ejemplo las calificaciones del alumno por campo (t√©cnico - matem√°ticas - y humanidades - portugu√©s). A√∫n as√≠, teniendo en cuenta los dos puntos anteriores, veo m√°s sentido tener una media de las calificaciones en total que aplicar√≠a de la siguiente forma:
========
OPCI√ìN A
========
- Para los alumnos que est√°n en matem√°ticas, la media de las tres evaluaciones como calificacion_tec
- Para los alumnos que est√°n en portugu√©s, la media de las tres evaluaciones como calificacion_hum
- Para los alumnos que est√°n en ambas clases, la media de calificacion_tec y calificacion_hum como calificacion_total
- Los alumnos que no apliquen en calificacion_tec o calificacion_mat, 'NA' como valor, y calificacion_total tambi?n 'NA'

Creo que as√≠ cubrir√≠amos bastante terreno seg√∫n lo que queramos hacer. A√∫n as√≠, algo m√°s simple si no nos interesa la calificaci√≥n por campos/asignaturas, puede ser:
========
OPCI√ìN B
========
- Para los alumnos que est√°n en matem√°ticas, la media de las tres evaluaciones como calificacion_total
- Para los alumnos que est√°n en portugu√©s, la media de las tres evaluaciones como calificacion_total

De esta √∫ltima forma queda un dataset m√°s "limpio". Dime qu√© opinas. De momento dejo los datasets en dos variables y luego ya elegimos:

```{r}
students_a <- students.both
students_a$calificacion_tec <- (students_a$G1.x + students_a$G2.x + students_a$G3.x) / 3
students_a$calificacion_hum <- (students_a$G1.y + students_a$G2.y + students_a$G3.y) / 3
students_a$calificacion_total <- (students_a$calificacion_tec + students_a$calificacion_hum) / 2

students_b <- students.both
students_b$calificacion_total <- ifelse(!is.na(students_a$calificacion_tec), students_a$calificacion_tec, students_a$calificacion_hum)


summary(students_a)
summary(students_b)
```

# Preparaci√≥n de datos para ver si existen agrupaciones claras seg√∫n ciertas variables

km_data <- students_b
km_data$studytime.x <- NULL
km_data$studytime.y <- NULL
km_data$failures.x <- NULL
km_data$failures.y <- NULL
km_data$paid.x <- NULL
km_data$paid.y <- NULL
km_data$G1.y <- NULL
km_data$G2.y <- NULL
km_data$G3.y <- NULL
km_data$G1.x <- NULL
km_data$G3.x <- NULL
km_data$G2.x <- NULL
km_data$studytime.x <- NULL
km_data$studytime.y <- NULL
km_data$failures.x <- NULL
km_data$failures.y <- NULL
summary(km_data)

# Seguir preparando datos y haciendo pruebas


