---
title: "Código Práctica 2: Limpieza dataset 'Student Alcohol Consumption '"
author: "Gregorio Andrés García Menéndez (gagarcia) & Manuel Gomez Montero (megmontero)"
date: "Junio, 2019"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
lang: es
---



```{r setup, include=FALSE}
# Change depending on your working directory
working_directory <- "F:/Drive/M?ster Data Science/Tipolog?a y ciclo de la vida de los datos/PRAC2/student-alcohol-consumption"

knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '', root.dir = working_directory)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(statnet.common)
```

**Introducción**

Práctica 2 de .... chapa... 



# Limpieza de datos


## Lectura de datos 

Leemos ambos ficheros mostramos resumén para matemáticas:

```{r}
students.mat=read.table("../data/student-mat.csv",sep=",",header=TRUE)
students.por=read.table("../data/student-por.csv",sep=",",header=TRUE)
summary(students.mat)


```


Y para portugués: 

```{r}
summary(students.por)
```

## Union de fuentes

En el código de ejemplo los unía a ver que ver si tiene sentido. ya que no son los mismos alumnos.

```{r}
students=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))
summary(students)
```


```{r}
students.both=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health"))
summary(students.both)
```

Vemos cuales realmente serian del mismo conjunto
```{r}
print(nrow(students.both[students$guardian.y!=students$guardian.x,c("guardian.x", "guardian.y")]))
print(nrow(students.both[students$guardian.y!=students$guardian.x,c("famsup.x", "famsup.y")]))
print(nrow(students.both[students$studytime.y!=students$studytime.x,c("studytime.x", "studytime.y")]))
print(nrow(students.both[students$paid.y!=students$paid.x,c("paid.x", "paid.y")]))
print(nrow(students.both[students$absences.y!=students$absences.x,c("absences.x", "absences.y")]))

```

Por lo que creamos el dataset final
```{r}
students.merge=merge(students.mat,students.por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime"), all = TRUE,suffixes = c(".mat",".por"))
summary(students.merge)

# Save the dataset temporaly 
write.table(students, "../data/students.csv", sep=",", col.names=TRUE, row.names=TRUE, quote=TRUE, na="NA")
```



## Eliminamos NAs


Primeros creamos un nuevo dataset y unificamos la variable paid. 
```{r}
students.nonas <- students.merge[, c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime")]
students.nonas$paid <- "no"
students.nonas$paid[NVL(students.merge$paid.mat == 'yes' | students.merge$paid.por == 'yes', FALSE)] <- "yes"
students.nonas$paid <- as.factor(students.nonas$paid)

summary(students.nonas)

```


Aplicamos un proceso similar para las calificaciones, utilizando la media en el caso que existan ambas:

```{r}
students.nonas$G1 <- rowMeans(students.merge[c('G1.mat', 'G1.por')], na.rm=TRUE)
students.nonas$G2 <- rowMeans(students.merge[c('G2.mat', 'G2.por')], na.rm=TRUE)
students.nonas$G3 <- rowMeans(students.merge[c('G3.mat', 'G3.por')], na.rm=TRUE)
summary(students.nonas)

```
Por último lo aplicamos a las ausencias, antes de aplicar la media normalizamos los valores

```{r}
normalized<-function(y) {
  x<-y[!is.na(y)]
  x<-(x - min(x)) / (max(x) - min(x))
  y[!is.na(y)]<-x
  return(y)
}


students.nonas$absences <- rowMeans(sapply(students.merge[c('absences.mat', 'absences.por')], normalized), na.rm=TRUE)

summary(students.nonas)  

```




## Reducción dimensionalidad


Eliminamos School y calculamos la evaluacion como la media
```{r}
students.red <- students.nonas[,c("sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "Dalc", "Walc", "health", "guardian", "famsup", "studytime", "absences", "paid")]
students.red$G <-  rowMeans(students.nonas[c('G1', 'G2', 'G3')])

summary(students.red)

```

## Tipo de variables

```{r}
sapply( students.red, class)

```

En los tipos mostrados hay algunos que no es correcto el tipo. En la educación tanto de la madre como del padre consideramos que aunque se use un número para la representación debería ser un factor. Lo mismo ocurre para el tiempo de viaje o el tiempo de estudio. 

```{r}
students.red$Medu <-as.factor(students.red$Medu) 
students.red$Fedu <-as.factor(students.red$Fedu) 
students.red$traveltime <-as.factor(students.red$traveltime) 
students.red$studytime <-as.factor(students.red$studytime) 

```



# Análisis Estadístico

## Análisis gráfico inicial

```{r}
vars = c("sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet", "traveltime", "failures", "schoolsup", "activities", "higher", "romantic", "famrel", "freetime", "goout", "health", "guardian", "famsup", "studytime", "absences", "paid", "G")
objs = c("Dalc", "Wcalc")



library(ggplot2)

for(i in vars) 
{
  if(is.factor(students.red[,i]))
  {
    f1 = students.red[,i]
plot <- ggplot(data = students.red, aes(x = f1, y = students.red[,"Walc"])) + 
  geom_boxplot(aes(fill = f1), width = 0.8) + theme_bw()  +
  xlab(i) + ylab("Weekend Consumption")
print(plot)
plot <- ggplot(data = students.red, aes(x = f1, y = students.red[,"Dalc"])) + 
  geom_boxplot(aes(fill = f1), width = 0.8) + theme_bw()  +
  xlab(i) + ylab("Weekday Consumption")
print(plot)


    }}

```



Viendo las gráficas vemos que hay variables que parece que sí tienen influencia a simple vista en el consumo de alcohol tanto a diarío como los fines de semana como pueden ser el sexo, el estado de los padres, sin embargo vemos otros que, a priori, no parece que tengan influencia así que en un primer momento vamos a dejar fuera del análisis si el alumno tiene internet, si tiene una relación, el tutor, la dirección, si realiza actividades extraescolares, si recibe clases de pago, si ha ido a la guarderia, o si  recibe el apoyo de su familia en el estudio. 

El dataset resultante y con el que continuaremos trabajando es el siguiente: 

```{r}
students <- students.red[,c("sex","age","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason", "traveltime", "failures", "schoolsup", "higher",  "famrel", "freetime", "goout", "Dalc", "Walc", "health", "studytime", "absences")]
summary(students)
```




## Estadistica Inferencial 

En este apartado vamos a ver si hay diferencia significativas en el consumo de alcohol a diario o fines de semana entre estudiantes de distinto sexo o entre estudiantes con diferente situación de los padres. Se trata de un problema de diferencia de medias entre dos muestras.


Para cada caso la hipótesis sería: 


$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_{g1}-\mu_{g2}=0\\
H_{1}: & \mu_{g1}-\mu_{g2}\ne0
\end{array}
\right.
$$

Se trata de un problema de diferencia de medias en el que no conocemos la varianza poblacional, tampoco sabemos a priori si los datos siguen una distribución normal, prero el tamaño de las muestras es lo suficientemente grande para tener en cuenta el teorema del límite central.


Para el alcohol en fines de semana por sexo: 

```{r}
data_weekend_sex_m <- students$Walc[students$sex == 'M'] 
data_weekend_sex_f <- students$Walc[students$sex == 'F'] 

t.test(data_weekend_sex_m, data_weekend_sex_f, var.equal = TRUE, conf.level = 0.90)
```
Por el p-value vemos que si podemos rechazar la hipótesis nula y concluir que si hay diferencias significativas. 



Por sexo entre semana: 

```{r}
data_weekday_sex_m <- students$Dalc[students$sex == 'M'] 
data_weekday_sex_f <- students$Dalc[students$sex == 'F'] 

t.test(data_weekday_sex_m, data_weekday_sex_f, var.equal = TRUE, conf.level = 0.90)
```
Por el p-value vemos que si podemos rechazar la hipótesis nula y concluir que si hay diferencias significativas. 


```{r}
data_weekday_pstatus_t <- students$Dalc[students$Pstatus == 'T'] 
data_weekday_pstatus_a <- students$Dalc[students$Pstatus == 'A'] 

t.test(data_weekday_pstatus_t, data_weekday_pstatus_a, var.equal = TRUE, conf.level = 0.90)
```
Por el p-value vemos que no hay diferencia significativa 



```{r}
data_weekend_pstatus_t <- students$Walc[students$Pstatus == 'T'] 
data_weekend_pstatus_a <- students$Walc[students$Pstatus == 'A'] 

t.test(data_weekend_pstatus_t, data_weekend_pstatus_a, var.equal = TRUE, conf.level = 0.90)
```
Por el p-value vemos que no hay diferencia significativa 




## Regresion 

En este apartado aplicaremos un modelo de regresión lineal múltiple que use como variables explicativas el sexo,
la frecuencia con la que el estudiante sale con amigos, la edad y como variable dependiente el consumo de alcohol los fines de semana. 

Al usar regresores cualitativos, es importante definir una categoría de referencia, para lo que usaremos la función de R *relevel* estableciendo la categoría "F" como referente para el sexo. El resultado lo almacenamos en una nueva  variable.


```{r}
students$sexR <- relevel(students$sex, "F")
modelo <- lm(Walc ~  goout + sexR + age, data = students )
summary(modelo)
```

Los coeficientes obtenidos para cada variable son: 


Observando el coeficiente de determinacion $R^{2}$ vemos que la proporción de variabilidad explicada por el modelo con respecto a la variabilidad total  es unicamente del 25% ...

OLD
------------------------------------------




# Análisis gráfico inicial





Sexo
```{r}
par(mfrow=c(1,2))
boxplot(Walc~sex,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~sex,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Parece que los hombres beben más.


Edad
```{r}
par(mfrow=c(1,2))
boxplot(Walc~age,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~age,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Parece que los mayores beben más entre semana.



             Fedu             Mjob           Fjob            reason    nursery   internet    traveltime       failures      schoolsup activities higher 
 
 
```{r}
par(mfrow=c(1,2))
boxplot(Walc~Medu,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~Medu,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```
 
 
```{r}
par(mfrow=c(1,2))
boxplot(Walc~Fedu,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~Fedu,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```
 
 
 
 


famsize
```{r}
par(mfrow=c(1,2))
boxplot(Walc~famsize,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~famsize,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```





Alcohol fin de sema y entre semana en función del estado de los padres 
```{r}
par(mfrow=c(1,2))

boxplot(Walc~Pstatus,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~Pstatus,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))

```


Si salen con amigos
```{r}
par(mfrow=c(1,2))
boxplot(Walc~goout,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~goout,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Parece que los que más salen, beben más los fines de semana. 



```{r}
par(mfrow=c(1,2))
boxplot(Walc~studytime,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~studytime,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Los que menos estudian, beben más los fines de semana.



```{r}
par(mfrow=c(1,2))
boxplot(Walc~famrel,data=students,  main="Boxplot Weekend Alcohol", ylab="Weekend Alcohol",col=(c("red","blue")))
boxplot(Dalc~famrel,data=students,  main="Boxplot Weekdays Alcohol", ylab="Weekdays Alcohol",col=(c("red","blue")))
```

Los que tienen buena relación con la familia no beben a diario. 






#Backup Goyo

Despu?s de hacer varias pruebas quitando y poniendo variables, he llegado a la conclusi?n de asumir todas como comunes para estudiantes que se encuentran en las dos clases excepto las notas (G1, G2 y G3).
Es decir, asumimos que alumnos cuyo todo conjunto de variables menos las notas es igual en los dos ficheros, se trata del mismo alumno. Haci?ndolo de este modo quedan:
```{r}
# 100 alumnos que dan matem?ticas y portugu?s 
nrow(students[!is.na(students$G1.x) & !is.na(students$G1.y),])
# 295 alumnos que dan s?lo matem?ticas
nrow(students[!is.na(students$G1.x) & is.na(students$G1.y),])
# 549 alumnos que dan s?lo portugu?s
nrow(students[is.na(students$G1.x) & !is.na(students$G1.y),])
# 0 datos an?malos (que no est?n en ninguna de las dos clases)
nrow(students[is.na(students$G1.x) & is.na(students$G1.y),])
```
Tras tener este dataset, nuestros objetivos pueden ser ver c?mo influyen ciertos factores sociales (tiempo libre, familia, etc) en dos cosas:
- Consumo de alcohol del alumno
- Calificaciones del alumno
(y la una sobre la otra seg?n que caso)

Se me ocurre que de este dataset se puede tambi?n estudiar por ejemplo las calificaciones del alumno por campo (técnico - matemáticas - y humanidades - portugués). Aún así, teniendo en cuenta los dos puntos anteriores, veo más sentido tener una media de las calificaciones en total que aplicaría de la siguiente forma:
========
OPCIÓN A
========
- Para los alumnos que están en matemáticas, la media de las tres evaluaciones como calificacion_tec
- Para los alumnos que están en portugués, la media de las tres evaluaciones como calificacion_hum
- Para los alumnos que están en ambas clases, la media de calificacion_tec y calificacion_hum como calificacion_total
- Los alumnos que no apliquen en calificacion_tec o calificacion_mat, 'NA' como valor, y calificacion_total tambi?n 'NA'

Creo que así cubriríamos bastante terreno según lo que queramos hacer. Aún así, algo más simple si no nos interesa la calificación por campos/asignaturas, puede ser:
========
OPCIÓN B
========
- Para los alumnos que están en matemáticas, la media de las tres evaluaciones como calificacion_total
- Para los alumnos que están en portugués, la media de las tres evaluaciones como calificacion_total

De esta última forma queda un dataset más "limpio". Dime qué opinas. De momento dejo los datasets en dos variables y luego ya elegimos:

```{r}
students_a <- students.both
students_a$calificacion_tec <- (students_a$G1.x + students_a$G2.x + students_a$G3.x) / 3
students_a$calificacion_hum <- (students_a$G1.y + students_a$G2.y + students_a$G3.y) / 3
students_a$calificacion_total <- (students_a$calificacion_tec + students_a$calificacion_hum) / 2

students_b <- students.both
students_b$calificacion_total <- ifelse(!is.na(students_a$calificacion_tec), students_a$calificacion_tec, students_a$calificacion_hum)


summary(students_a)
summary(students_b)
```

# Preparación de datos para ver si existen agrupaciones claras según ciertas variables

km_data <- students_b
km_data$studytime.x <- NULL
km_data$studytime.y <- NULL
km_data$failures.x <- NULL
km_data$failures.y <- NULL
km_data$paid.x <- NULL
km_data$paid.y <- NULL
km_data$G1.y <- NULL
km_data$G2.y <- NULL
km_data$G3.y <- NULL
km_data$G1.x <- NULL
km_data$G3.x <- NULL
km_data$G2.x <- NULL
km_data$studytime.x <- NULL
km_data$studytime.y <- NULL
km_data$failures.x <- NULL
km_data$failures.y <- NULL
summary(km_data)

# Seguir preparando datos y haciendo pruebas


